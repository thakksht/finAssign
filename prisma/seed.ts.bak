import { PrismaClient } from '../src/generated/prisma'
import { faker } from '@faker-js/faker'

const prisma = new PrismaClient()

async function main() {
  // Create default user
  const user = await prisma.user.upsert({
    where: { id: 'user123' },
    update: {},
    create: {
      id: 'user123',
      email: 'user@example.com',
      name: 'Test User',
    },
  })

  console.log(`Created user: ${user.name}`)
  
  // Delete existing transactions and categories to start fresh
  try {
    await prisma.transaction.deleteMany({
      where: { userId: 'user123' },
    })
    
    await prisma.category.deleteMany({
      where: { userId: 'user123' },
    })
  } catch (error) {
    console.log('No data to delete')
  }
  
  // Create default categories
  const expenseCategories = [
    { name: 'Food', color: '#10B981' }, // Green
    { name: 'Rent', color: '#6366F1' }, // Indigo
    { name: 'Utilities', color: '#F59E0B' }, // Amber
    { name: 'Transportation', color: '#3B82F6' }, // Blue
    { name: 'Entertainment', color: '#EC4899' }, // Pink
    { name: 'Healthcare', color: '#EF4444' }, // Red
    { name: 'Shopping', color: '#8B5CF6' }, // Purple
    { name: 'Travel', color: '#0EA5E9' }, // Sky
    { name: 'Education', color: '#14B8A6' }, // Teal
    { name: 'Other Expenses', color: '#71717A' }, // Gray
  ]
  
  const incomeCategories = [
    { name: 'Salary', color: '#10B981' }, // Green
    { name: 'Freelance', color: '#6366F1' }, // Indigo
    { name: 'Gifts', color: '#F59E0B' }, // Amber
    { name: 'Investments', color: '#3B82F6' }, // Blue
    { name: 'Refunds', color: '#EC4899' }, // Pink
    { name: 'Other Income', color: '#71717A' }, // Gray
  ]
  
  const categories = {}
  
  // Create expense categories
  for (const cat of expenseCategories) {
    const category = await prisma.category.create({
      data: {
        name: cat.name,
        color: cat.color,
        userId: user.id,
      },
    })
    categories[cat.name] = category
  }
  
  // Create income categories
  for (const cat of incomeCategories) {
    const category = await prisma.category.create({
      data: {
        name: cat.name,
        color: cat.color,
        userId: user.id,
      },
    })
    categories[cat.name] = category
  }

  console.log(`Created ${Object.keys(categories).length} categories`)
  // Create sample transactions
  const currentDate = new Date()
  const transactions = []
  
  // Get category mappings
  const allCategoryObjects = await prisma.category.findMany({
    where: { userId: user.id }
  });
  
  // Create a mapping of category names to category IDs
  const categoryMap: Record<string, string> = {};
  for (const cat of allCategoryObjects) {
    categoryMap[cat.name] = cat.id;
  }

  // Generate transactions for the last 6 months
  for (let i = 0; i < 50; i++) {
    // Create random date within last 6 months
    const randomDate = new Date(
      currentDate.getFullYear(),
      currentDate.getMonth() - Math.floor(Math.random() * 6),
      Math.floor(Math.random() * 28) + 1
    )

    // Randomly determine if it's an expense or income
    const isExpense = Math.random() > 0.3 // 70% chance of being an expense
    
    const categoryOptions = isExpense
      ? ['Food', 'Rent', 'Utilities', 'Entertainment', 'Shopping', 'Transportation', 'Healthcare', 'Travel', 'Education', 'Other Expenses']
      : ['Salary', 'Freelance', 'Gifts', 'Investments', 'Refunds', 'Other Income']
    
    const categoryName = categoryOptions[Math.floor(Math.random() * categoryOptions.length)]
    const categoryId = categoryMap[categoryName]
    
    // Generate amount (expenses are negative)
    let amount
    if (isExpense) {
      amount = -(Math.random() * 200 + 10).toFixed(2)
    } else {
      amount = (Math.random() * 1000 + 500).toFixed(2)
    }

    const transaction = await prisma.transaction.create({
      data: {
        amount: parseFloat(amount as string),
        description: `${categoryName} - ${faker.lorem.words(2)}`,
        date: randomDate,
        userId: user.id,
        categoryId: categoryId
      },
    })

    transactions.push(transaction)
  }

  console.log(`Created ${transactions.length} sample transactions`)
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
